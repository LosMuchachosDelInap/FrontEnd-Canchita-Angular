<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <!-- Campos para login -->
  @if (tipo === 'sign-in') {
    <div class="form-section">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Email</mat-label>
        <input matInput type="email" formControlName="email" placeholder="tu@email.com">
        <mat-icon matSuffix>email</mat-icon>
        @if (form.get('email')?.hasError('required')) {
          <mat-error>El email es requerido</mat-error>
        }
        @if (form.get('email')?.hasError('email')) {
          <mat-error>Ingrese un email válido</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Contraseña</mat-label>
        <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="clave" placeholder="Contraseña">
        <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword" type="button">
          <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
        </button>
        @if (form.get('clave')?.hasError('required')) {
          <mat-error>La contraseña es requerida</mat-error>
        }
      </mat-form-field>
    </div>
  }

  <!-- Campos para registro y crear/editar usuario -->
  @if (tipo === 'sign-up' || tipo === 'editar' || tipo === 'detalle' || tipo === 'crear') {
    <div class="form-section">
      <!-- Nombre y Apellido -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="nombre" placeholder="Nombre" [readonly]="isReadOnlyMode()">
          <mat-icon matSuffix>person</mat-icon>
          @if (form.get('nombre')?.hasError('required')) {
            <mat-error>El nombre es requerido</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Apellido</mat-label>
          <input matInput formControlName="apellido" placeholder="Apellido" [readonly]="isReadOnlyMode()">
          <mat-icon matSuffix>person</mat-icon>
          @if (form.get('apellido')?.hasError('required')) {
            <mat-error>El apellido es requerido</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Email -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Email</mat-label>
        <input matInput type="email" formControlName="email" placeholder="tu@email.com" [readonly]="isReadOnlyMode()">
        <mat-icon matSuffix>email</mat-icon>
        @if (form.get('email')?.hasError('required')) {
          <mat-error>El email es requerido</mat-error>
        }
        @if (form.get('email')?.hasError('email')) {
          <mat-error>Ingrese un email válido</mat-error>
        }
      </mat-form-field>

      <!-- Contraseña (oculta en modo de solo lectura) -->
      @if (!isReadOnlyMode()) {
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Contraseña</mat-label>
          <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="clave" placeholder="Contraseña">
          <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword" type="button">
            <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          @if (form.get('clave')?.hasError('required')) {
            <mat-error>La contraseña es requerida</mat-error>
          }
          @if (form.get('clave')?.hasError('minlength')) {
            <mat-error>La contraseña debe tener al menos 6 caracteres</mat-error>
          }
        </mat-form-field>

        <!-- Mensaje informativo para edición -->
        @if (tipo === 'editar') {
          <div class="password-info">
            <mat-icon>info</mat-icon>
            <span>Deja en blanco la contraseña si no quieres cambiarla</span>
          </div>
        }
      }

      <!-- Campos adicionales para registro y edición -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>DNI</mat-label>
          <input matInput formControlName="dni" placeholder="12345678" maxlength="8" [readonly]="isReadOnlyMode()">
          <mat-icon matSuffix>badge</mat-icon>
          @if (form.get('dni')?.hasError('required')) {
            <mat-error>El DNI es requerido</mat-error>
          }
          @if (form.get('dni')?.hasError('pattern')) {
            <mat-error>DNI debe tener 7 u 8 dígitos</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Edad</mat-label>
          <input matInput type="number" formControlName="edad" placeholder="18" min="16" max="99" [readonly]="isReadOnlyMode()">
          <mat-icon matSuffix>cake</mat-icon>
          @if (form.get('edad')?.hasError('required')) {
            <mat-error>La edad es requerida</mat-error>
          }
          @if (form.get('edad')?.hasError('min')) {
            <mat-error>La edad debe ser mayor a 15</mat-error>
          }
          @if (form.get('edad')?.hasError('max')) {
            <mat-error>La edad debe ser menor a 100</mat-error>
          }
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Teléfono</mat-label>
        <input matInput formControlName="telefono" placeholder="11 1234-5678" maxlength="11" [readonly]="isReadOnlyMode()">
        <mat-icon matSuffix>phone</mat-icon>
        @if (form.get('telefono')?.hasError('required')) {
          <mat-error>El teléfono es requerido</mat-error>
        }
        @if (form.get('telefono')?.hasError('pattern')) {
          <mat-error>Teléfono debe tener 10 u 11 dígitos</mat-error>
        }
      </mat-form-field>

      <!-- Rol (para creación, edición y vista de usuarios desde admin) -->
      @if (shouldShowRoleField()) {
        @if (isReadOnlyMode()) {
          <!-- Mostrar rol como campo de solo lectura -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Rol del Usuario</mat-label>
            <input matInput [value]="getRoleText(form.get('rol')?.value)" readonly>
            <mat-icon matSuffix>admin_panel_settings</mat-icon>
          </mat-form-field>
        } @else {
          <!-- Mostrar rol como select editable -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Rol del Usuario</mat-label>
            <mat-select formControlName="rol">
              @for (role of availableRoles; track role.value) {
                <mat-option [value]="role.value">
                  {{role.label}}
                </mat-option>
              }
            </mat-select>
            <mat-icon matSuffix>admin_panel_settings</mat-icon>
            @if (form.get('rol')?.hasError('required')) {
              <mat-error>Seleccione un rol</mat-error>
            }
          </mat-form-field>
        }
      }

      <!-- Información del rol cuando es registro público (no dueño) -->
      @if (tipo === 'sign-up' && !isOwnerRegistering) {
        <div class="role-info">
          <mat-icon>info</mat-icon>
          <span>Te registrarás como Cliente. Un administrador puede cambiar tu rol después.</span>
        </div>
      }

      <!-- Información para modo de solo lectura -->
      @if (isReadOnlyMode()) {
        <div class="readonly-info">
          <mat-icon>visibility</mat-icon>
          <span>Estás viendo los detalles del usuario. Para modificar, usa el botón de editar.</span>
        </div>
      }
    </div>
  }

  <!-- Campos para contacto -->
  @if (tipo === 'contacto') {
    <div class="form-section">
      <!-- Nombre y Apellido -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="nombre" placeholder="Nombre">
          <mat-icon matSuffix>person</mat-icon>
          @if (form.get('nombre')?.hasError('required')) {
            <mat-error>El nombre es requerido</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Apellido</mat-label>
          <input matInput formControlName="apellido" placeholder="Apellido">
          <mat-icon matSuffix>person</mat-icon>
          @if (form.get('apellido')?.hasError('required')) {
            <mat-error>El apellido es requerido</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Email y Teléfono -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Email</mat-label>
          <input matInput type="email" formControlName="email" placeholder="tu@email.com">
          <mat-icon matSuffix>email</mat-icon>
          @if (form.get('email')?.hasError('required')) {
            <mat-error>El email es requerido</mat-error>
          }
          @if (form.get('email')?.hasError('email')) {
            <mat-error>Ingrese un email válido</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Teléfono</mat-label>
          <input matInput formControlName="telefono" placeholder="11 1234-5678" maxlength="11">
          <mat-icon matSuffix>phone</mat-icon>
          @if (form.get('telefono')?.hasError('required')) {
            <mat-error>El teléfono es requerido</mat-error>
          }
          @if (form.get('telefono')?.hasError('pattern')) {
            <mat-error>Teléfono debe tener 10 u 11 dígitos</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Mensaje -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Mensaje o Consulta</mat-label>
        <textarea 
          matInput 
          formControlName="mensaje" 
          placeholder="Escribe tu consulta o sugerencia aquí..."
          rows="4">
        </textarea>
        <mat-icon matSuffix>message</mat-icon>
        @if (form.get('mensaje')?.hasError('required')) {
          <mat-error>El mensaje es requerido</mat-error>
        }
        @if (form.get('mensaje')?.hasError('minlength')) {
          <mat-error>El mensaje debe tener al menos 10 caracteres</mat-error>
        }
      </mat-form-field>
    </div>
  }

  <!-- Botones de acción -->
  <div class="form-actions">
    @if (isReadOnlyMode()) {
      <!-- Solo botón de cerrar para modo de solo lectura -->
      <button 
        mat-raised-button 
        color="primary" 
        type="button" 
        (click)="onCancel()">
        <mat-icon>close</mat-icon>
        Cerrar
      </button>
    } @else {
      <!-- Botones normales para modos de edición -->
      <button 
        mat-button 
        type="button" 
        (click)="onCancel()"
        [disabled]="loading">
        Cancelar
      </button>
      
      <button 
        mat-raised-button 
        color="primary" 
        type="submit"
        [disabled]="form.invalid || loading">
        
        @if (loading) {
          <ng-container>
            <mat-icon>refresh</mat-icon>
            <span>{{getLoadingText()}}</span>
          </ng-container>
        }
        @else {
          <span>{{getSubmitButtonText()}}</span>
        }
      </button>
    }
  </div>

  <!-- Información adicional -->
  @if (tipo === 'sign-in') {
    <div class="additional-info">
      <p>¿No tienes cuenta? 
        <button mat-button color="primary" type="button" (click)="switchToRegister()">
          Regístrate aquí
        </button>
      </p>
    </div>
  }

  @if (tipo === 'sign-up') {
    <div class="additional-info">
      <p>¿Ya tienes cuenta? 
        <button mat-button color="primary" type="button" (click)="switchToLogin()">
          Inicia sesión
        </button>
      </p>
    </div>
  }
</form>
